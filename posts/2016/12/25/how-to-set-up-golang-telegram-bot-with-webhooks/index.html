<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>How I Built a Simple Telegram Bot in Go</title>

    <meta name="description" content="In this post, I go through all the steps I took to build a simple telegram bot in Go. I run through the important bits in the code samples as well as some choices I made for each of the important c..." />
<meta property="og:site_name" content="aranair.github.io" />
<meta property="og:title" content="How I Built a Simple Telegram Bot in Go" />

    <!-- Bootstrap Stuff -->
    <link href=rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700|Lato|Montserrat">
    <link href="/stylesheets/normalize-ef7858ef.css" rel="stylesheet" />
    <link href="/stylesheets/blog-1fe4e2c3.css" rel="stylesheet" />
    <script src="/javascripts/all-6e6341dd.js" async="true"></script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51305292-1', 'auto');
  ga('send', 'pageview');
</script>

  </head>
  <body class="posts posts_2016 posts_2016_12 posts_2016_12_25 posts_2016_12_25_how-to-set-up-golang-telegram-bot-with-webhooks posts_2016_12_25_how-to-set-up-golang-telegram-bot-with-webhooks_index">
    <header id="header" class="header header--fixed" role="banner">
  <nav class="navbar navbar-default">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapsible-content" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/" class="navbar-links navbar-links--name pull-left">
      </a>
    </div>

    <div class="collapse navbar-collapse" id="navbar-collapsible-content">
      <a href="/posts" class="navbar-links pull-right">
        Posts
      </a>
      <a href="/projects" class="navbar-links pull-right">
        Projects
      </a>
      <a href="/bio" class="navbar-links pull-right">
        Bio
      </a>
    </div>
  </nav>
</header>

    <div class="wrapper">
      <div class="container">
        <div class="tags">
    <a href="/posts/tags/golang/" class="tags-link">golang</a>
    <a href="/posts/tags/telegram/" class="tags-link">telegram</a>
    <a href="/posts/tags/bot/" class="tags-link">bot</a>
    <a href="/posts/tags/webhooks/" class="tags-link">webhooks</a>
    <a href="/posts/tags/elasticsearch/" class="tags-link">elasticsearch</a>
    <a href="/posts/tags/aws/" class="tags-link">aws</a>
    <a href="/posts/tags/emr/" class="tags-link">emr</a>
    <a href="/posts/tags/apache-pig/" class="tags-link">apache pig</a>
    <a href="/posts/tags/hadoop/" class="tags-link">hadoop</a>
    <a href="/posts/tags/datapipeline/" class="tags-link">datapipeline</a>
    <a href="/posts/tags/ecs/" class="tags-link">ecs</a>
    <a href="/posts/tags/found-io/" class="tags-link">found.io</a>
    <a href="/posts/tags/elastic-cloud/" class="tags-link">elastic-cloud</a>
    <a href="/posts/tags/rails/" class="tags-link">rails</a>
    <a href="/posts/tags/try/" class="tags-link">try</a>
    <a href="/posts/tags/capybara/" class="tags-link">capybara</a>
    <a href="/posts/tags/docker/" class="tags-link">docker</a>
    <a href="/posts/tags/devops/" class="tags-link">devops</a>
    <a href="/posts/tags/capistrano/" class="tags-link">capistrano</a>
    <a href="/posts/tags/heka/" class="tags-link">heka</a>
    <a href="/posts/tags/bigquery/" class="tags-link">bigquery</a>
    <a href="/posts/tags/kafka/" class="tags-link">kafka</a>
    <a href="/posts/tags/protobuf/" class="tags-link">protobuf</a>
    <a href="/posts/tags/vim/" class="tags-link">vim</a>
    <a href="/posts/tags/iterm/" class="tags-link">iterm</a>
    <a href="/posts/tags/javascript/" class="tags-link">javascript</a>
    <a href="/posts/tags/emberjs/" class="tags-link">emberjs</a>
    <a href="/posts/tags/git/" class="tags-link">git</a>
    <a href="/posts/tags/scripting/" class="tags-link">scripting</a>
    <a href="/posts/tags/dnsmasq/" class="tags-link">dnsmasq</a>
    <a href="/posts/tags/bem/" class="tags-link">bem</a>
    <a href="/posts/tags/frontend/" class="tags-link">frontend</a>
    <a href="/posts/tags/meteorjs/" class="tags-link">meteorjs</a>
    <a href="/posts/tags/meteorite/" class="tags-link">meteorite</a>
    <a href="/posts/tags/heroku/" class="tags-link">heroku</a>
</div>


          <div class="article row">
    <h1 class="page-header article__article-title">
      How I Built a Simple Telegram Bot in Go<br>
    </h1>
    <div class="article__published-date">
      Dec 25, 2016
      <span class="article__middle-dot"></span>
      20  minutes read
    </div>
    <div class="article__tags-container">
      <ul class="article__tags">
        <li class="article__tag">
          <a href="/posts/tags/golang/" class="article__tag-link">golang</a>
        </li>
        <li class="article__tag">
          <a href="/posts/tags/telegram/" class="article__tag-link">telegram</a>
        </li>
        <li class="article__tag">
          <a href="/posts/tags/bot/" class="article__tag-link">bot</a>
        </li>
        <li class="article__tag">
          <a href="/posts/tags/webhooks/" class="article__tag-link">webhooks</a>
        </li>
      </ul>
    </div>
    <hr>

    <div class="article__content">
      <p>This is the first part of the <code>Golang Telegram Bot</code> series. 
In this series, I&rsquo;ll show you, with code samples, how I built a Golang Telegram Bot for my own use. 
It would listen in and respond in real-time to certain text cues. 
Finally I&rsquo;ll also show you how to get a self-signed SSL cert working with Nginx
and deploying the application in a Docker container on a Digital Ocean instance.</p>

<p>Hopefully this will help anyone out there who would like to try their hand at their own bot on Telegram!
The code for this bot is currently hosted at <a href="https://github.com/aranair/remindbot">https://github.com/aranair/remindbot</a> if you&rsquo;ll like
to just skip to the code immediately.</p>

<h3>Backstory</h3>

<p>I&rsquo;ve been using <a href="https://web.telegram.org">Telegram</a> for a really long time, and been wanting to build a Telegram bot 
for a long time since they first announced it. </p>

<p>Initially, I was thrown off a little by the requirement of https for the webhooks, 
thinking that I might need a domain and a SSL cert to get it working but I quickly found out that
a self-signed SSL certificate would work just as well in this scenario!</p>

<p>So, if you find yourself in the same situation, don&rsquo;t worry about it! It might be slightly more complex 
to set up a self-signed SSL cert with Nginx, but it&rsquo;s not that difficult! In this series, I&rsquo;ll show you the code
samples that got my own bot up and running in production!</p>

<h3>Creating a Bot and Getting an API Key</h3>

<p>First, I sent <code>/newbot</code> to this guy.</p>

<p><a href="https://telegram.me/botfather"><img src="https://s24.postimg.org/d0amvsmut/botfather.png" alt="botfather.png" /></a></p>

<p>After creating the bot, I got a set of (botId and API key) by sending him a <code>/token</code> command.<br>
The credentials are needed for subsequent requests to execute methods using the Telegram API. </p>
<pre class="highlight yaml"><code><span class="c1"># {botId}:{apiKey}</span>
<span class="s">123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11</span>
</code></pre>
<p><strong>Take note</strong> of the word <code>bot</code> before the <code>&lt;token&gt;</code>!</p>
<pre class="highlight yaml"><code><span class="s">https://api.telegram.org/bot&lt;token&gt;/METHOD_NAME</span>
</code></pre>
<p>There are a ton of Api methods listed over at the <a href="https://core.telegram.org/bots/api#available-methods">Telegram Bot docs</a> but for the purpose
of this simple starter bot, I will only be using <a href="https://core.telegram.org/bots/api#setwebhook">setWebhook</a> and <a href="https://core.telegram.org/bots/api#sendMessage">sendMessage</a>.</p>

<h3>Webhook vs Polling</h3>

<p>Great! I have the API key now. Next, I have to choose between the two ways to get messages from Telegram.</p>

<ul>
<li>Webhooks via <code>setWebhook</code> or</li>
<li>Polling via <code>getUpdates</code></li>
</ul>

<p>I&rsquo;m fairly certain that it is easier to set up with <code>getUpdates</code> but polling isn&rsquo;t always an option and not having
real-time updates isn&rsquo;t as fun IMHO :P So, for this bot, I went with webhooks as I wanted the bot to respond in real-time.</p>

<p>With webhooks, everytime there is a message (when privacy mode is disabled anyway), the API endpoint
will be sent a message. So the main objective, is simply, to parse each of these updates and respond appropriately.</p>

<p>To set up the Webhook all I had to do is to send a curl request to the Telegram Api.</p>
<pre class="highlight shell"><code>curl -F <span class="s2">"url=https://your.domain.com"</span> -F <span class="s2">"certificate=@/file/path/ssl/bot.pem"</span> https://api.telegram.org/bot12345:ABC-DEF1234ghIkl-zyx57W2v1u123ew11/setWebhook
</code></pre>
<p>Of course, before that, I need the self-signed SSL <strong>public</strong> pem file; that is sent as an <code>InputFile</code> so that
Telegram can differentiate the correct server it&rsquo;s supposed to send all the messages to. This part is a bit more relevant
in the second part of the series where I deploy the bot to Digital Ocean so I&rsquo;ll leave this explanation to the second part.</p>

<h3>Router</h3>

<p>I had a choice of many popular router implementations out there like <a href="https://github.com/gin-gonic/gin">gin</a> and <a href="https://github.com/gorilla/context">gorilla</a>.
But for this project, I chose to go a bit ligher with just <code>github.com/gorilla/context</code> and 
<code>github.com/julienschmidt/httprouter</code> since I don&rsquo;t really need that much functionality.</p>

<p><em>Ok, to be fair, even the context (for the params) isn&rsquo;t really needed at this point, but
since I would need them for get requests in future, I&rsquo;ve set it all up first.</em></p>
<pre class="highlight go"><code><span class="k">package</span><span class="x"> </span><span class="n">router</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="x">
    </span><span class="s">"net/http"</span><span class="x">

    </span><span class="s">"github.com/gorilla/context"</span><span class="x">
    </span><span class="s">"github.com/julienschmidt/httprouter"</span><span class="x">
</span><span class="p">)</span><span class="x">

</span><span class="k">type</span><span class="x"> </span><span class="n">router</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="o">*</span><span class="n">httprouter</span><span class="o">.</span><span class="n">Router</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">New</span><span class="p">()</span><span class="x"> </span><span class="o">*</span><span class="n">router</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="o">&amp;</span><span class="n">router</span><span class="p">{</span><span class="n">httprouter</span><span class="o">.</span><span class="n">New</span><span class="p">()}</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">router</span><span class="p">)</span><span class="x"> </span><span class="n">POST</span><span class="p">(</span><span class="n">path</span><span class="x"> </span><span class="kt">string</span><span class="p">,</span><span class="x"> </span><span class="n">h</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">Handler</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">r</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"POST"</span><span class="p">,</span><span class="x"> </span><span class="n">path</span><span class="p">,</span><span class="x"> </span><span class="n">wrapHandler</span><span class="p">(</span><span class="n">h</span><span class="p">))</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">wrapHandler</span><span class="p">(</span><span class="n">h</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">Handler</span><span class="p">)</span><span class="x"> </span><span class="n">httprouter</span><span class="o">.</span><span class="n">Handle</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="k">func</span><span class="p">(</span><span class="n">w</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span><span class="x"> </span><span class="n">ps</span><span class="x"> </span><span class="n">httprouter</span><span class="o">.</span><span class="n">Params</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">context</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="x"> </span><span class="s">"params"</span><span class="p">,</span><span class="x"> </span><span class="n">ps</span><span class="p">)</span><span class="x">
        </span><span class="n">h</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
<h3>Configs</h3>

<p>To parse the config toml file, I used <code>github.com/BurntSushi/toml</code> with <code>toml</code> files. It&rsquo;s like <code>yml</code> on steroids lol.</p>

<p>The <code>datapath</code> is actually the data volume path for Docker; but I&rsquo;ll talk about that in more details in the second part 
of this series about deployments.</p>

<p><strong>Sample configs.toml</strong></p>
<pre class="highlight go"><code><span class="p">[</span><span class="n">bot</span><span class="p">]</span><span class="x">
  </span><span class="n">bot_id</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"YOUR_BOT_ID"</span><span class="x">
  </span><span class="n">api_key</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"YOUR_API_KEY"</span><span class="x">
</span><span class="p">[</span><span class="n">database</span><span class="p">]</span><span class="x">
  </span><span class="n">datapath</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"PATH_TO_SQLITEE_FOLDER"</span><span class="x">
</span></code></pre>
<h3>App Context / Http Handlers Glue</h3>

<p>Instead of a global object, I mixed app-wide objects like configs and the DB object into an <code>AppContext</code>.
To link the <code>AppContext</code> and the <code>http handlers</code> together, I used <a href="https://github.com/justinas/alice">github.com/justinas/alice</a> as the glue.</p>

<p><strong>App Context</strong>:</p>
<pre class="highlight go"><code><span class="k">type</span><span class="x"> </span><span class="n">AppContext</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">db</span><span class="x">   </span><span class="o">*</span><span class="n">sql</span><span class="o">.</span><span class="n">DB</span><span class="x">
    </span><span class="n">conf</span><span class="x"> </span><span class="n">config</span><span class="o">.</span><span class="n">Config</span><span class="x">
    </span><span class="n">cmds</span><span class="x"> </span><span class="n">commands</span><span class="o">.</span><span class="n">Commands</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">NewAppContext</span><span class="p">(</span><span class="n">db</span><span class="x"> </span><span class="o">*</span><span class="n">sql</span><span class="o">.</span><span class="n">DB</span><span class="p">,</span><span class="x"> </span><span class="n">conf</span><span class="x"> </span><span class="n">config</span><span class="o">.</span><span class="n">Config</span><span class="p">,</span><span class="x"> </span><span class="n">cmds</span><span class="x"> </span><span class="n">commands</span><span class="o">.</span><span class="n">Commands</span><span class="p">)</span><span class="x"> </span><span class="n">AppContext</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">AppContext</span><span class="p">{</span><span class="n">db</span><span class="o">:</span><span class="x"> </span><span class="n">db</span><span class="p">,</span><span class="x"> </span><span class="n">conf</span><span class="o">:</span><span class="x"> </span><span class="n">conf</span><span class="p">,</span><span class="x"> </span><span class="n">cmds</span><span class="o">:</span><span class="x"> </span><span class="n">cmds</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
<p><strong>Message Receiver</strong>:</p>
<pre class="highlight go"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">ac</span><span class="x"> </span><span class="o">*</span><span class="n">AppContext</span><span class="p">)</span><span class="x"> </span><span class="n">CommandHandler</span><span class="p">(</span><span class="n">w</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x"> </span><span class="o">...</span><span class="x"> </span><span class="p">}</span><span class="x">
</span></code></pre>
<p><strong>Main</strong></p>

<p>Since this bot was mainly built for personal reminders, I&rsquo;ve chosen to go with <code>Sqlite3</code> for now but I&rsquo;ve 
got it set up with <code>pq</code> before and it is fairly easy to swap it out, since both the libraries uses the <code>database/sql</code> 
library.</p>
<pre class="highlight go"><code><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">toml</span><span class="o">.</span><span class="n">DecodeFile</span><span class="p">(</span><span class="s">"configs.toml"</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">conf</span><span class="p">)</span><span class="x">
</span><span class="n">db</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">sql</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"sqlite3"</span><span class="p">,</span><span class="x"> </span><span class="n">conf</span><span class="o">.</span><span class="n">DB</span><span class="o">.</span><span class="n">Datapath</span><span class="o">+</span><span class="s">"/reminders.db"</span><span class="p">)</span><span class="x">
</span><span class="n">checkErr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">

</span><span class="n">ac</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">handlers</span><span class="o">.</span><span class="n">NewAppContext</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="x"> </span><span class="n">conf</span><span class="p">,</span><span class="x"> </span><span class="n">commands</span><span class="o">.</span><span class="n">NewCommandList</span><span class="p">())</span><span class="x">

</span><span class="n">stack</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">alice</span><span class="o">.</span><span class="n">New</span><span class="p">()</span><span class="x">
</span><span class="n">r</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">router</span><span class="o">.</span><span class="n">New</span><span class="p">()</span><span class="x">
</span><span class="n">r</span><span class="o">.</span><span class="n">POST</span><span class="p">(</span><span class="s">"/reminders"</span><span class="p">,</span><span class="x"> </span><span class="n">stack</span><span class="o">.</span><span class="n">ThenFunc</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">CommandHandler</span><span class="p">))</span><span class="x">

</span><span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":8080"</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="p">)</span><span class="x">
</span></code></pre>
<h3>Parsing the Updates</h3>

<p>The updates that Telegram sends to the bot contains a lot of fields, including some optional ones 
that may or may not appear depending on the type of update, but the ones I&rsquo;m concerned with for
this bot are only these:</p>
<pre class="highlight go"><code><span class="k">type</span><span class="x"> </span><span class="n">Update</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">Id</span><span class="x">  </span><span class="kt">int64</span><span class="x">   </span><span class="s">`json:"update_id"`</span><span class="x">
    </span><span class="n">Msg</span><span class="x"> </span><span class="n">Message</span><span class="x"> </span><span class="s">`json:"message"`</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">type</span><span class="x"> </span><span class="n">Message</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">Id</span><span class="x">   </span><span class="kt">int64</span><span class="x">  </span><span class="s">`json:"message_id"`</span><span class="x">
    </span><span class="n">Text</span><span class="x"> </span><span class="kt">string</span><span class="x"> </span><span class="s">`json:"text"`</span><span class="x">
    </span><span class="n">Chat</span><span class="x"> </span><span class="n">Chat</span><span class="x">   </span><span class="s">`json:"chat"`</span><span class="x">
    </span><span class="n">User</span><span class="x"> </span><span class="n">User</span><span class="x">   </span><span class="s">`json:"from"`</span><span class="x"> </span><span class="err">#</span><span class="x"> </span><span class="n">Note</span><span class="o">:</span><span class="x"> </span><span class="n">this</span><span class="x"> </span><span class="n">is</span><span class="x"> </span><span class="n">an</span><span class="x"> </span><span class="n">optional</span><span class="x"> </span><span class="n">field</span><span class="x"> </span><span class="n">so</span><span class="x"> </span><span class="n">it</span><span class="x"> </span><span class="n">may</span><span class="x"> </span><span class="n">be</span><span class="x"> </span><span class="n">empty</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">type</span><span class="x"> </span><span class="n">Chat</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">Id</span><span class="x">    </span><span class="kt">int64</span><span class="x">  </span><span class="s">`json:"id"`</span><span class="x">
    </span><span class="n">Title</span><span class="x"> </span><span class="kt">string</span><span class="x"> </span><span class="s">`json:"title"`</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">type</span><span class="x"> </span><span class="n">User</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">Id</span><span class="x">        </span><span class="kt">int64</span><span class="x">  </span><span class="s">`json:"id"`</span><span class="x">
    </span><span class="n">FirstName</span><span class="x"> </span><span class="kt">string</span><span class="x"> </span><span class="s">`json:"first_name"`</span><span class="x">
    </span><span class="n">Username</span><span class="x">  </span><span class="kt">string</span><span class="x"> </span><span class="s">`json:"username"`</span><span class="x"> </span><span class="err">#</span><span class="x"> </span><span class="n">Note</span><span class="o">:</span><span class="x"> </span><span class="n">another</span><span class="x"> </span><span class="n">optional</span><span class="x"> </span><span class="n">field</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
<p>Updates comes in as <code>JSON</code> and you can use the code snippet below with the structs above to decode it
into a more usable object.</p>
<pre class="highlight go"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">ac</span><span class="x"> </span><span class="o">*</span><span class="n">AppContext</span><span class="p">)</span><span class="x"> </span><span class="n">CommandHandler</span><span class="p">(</span><span class="n">w</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">var</span><span class="x"> </span><span class="n">update</span><span class="x"> </span><span class="n">Update</span><span class="x">

    </span><span class="n">decoder</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">json</span><span class="o">.</span><span class="n">NewDecoder</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">decoder</span><span class="o">.</span><span class="n">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">update</span><span class="p">);</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">Msg</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">

    </span><span class="n">cmd</span><span class="p">,</span><span class="x"> </span><span class="n">txt</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">ac</span><span class="o">.</span><span class="n">cmds</span><span class="o">.</span><span class="n">Extract</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">Msg</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span><span class="x">
    </span><span class="n">chatId</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">update</span><span class="o">.</span><span class="n">Msg</span><span class="o">.</span><span class="n">Chat</span><span class="o">.</span><span class="n">Id</span><span class="x">

    </span><span class="k">switch</span><span class="x"> </span><span class="n">s</span><span class="o">.</span><span class="n">ToLower</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
      </span><span class="o">...</span><span class="x">
    </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
<p><strong>Some key things to note here:</strong></p>

<ul>
<li>The message is parsed into <code>update.Msg.Text</code></li>
<li>The <code>chatId</code> is in <code>update.Msg.Chat.Id</code>. This is important because you&rsquo;ll need it to send a 
response back.</li>
<li>The bot currently doesn&rsquo;t use <code>User</code> but I&rsquo;ve written the code above so that you can get it as well.</li>
</ul>

<h3>Command Extraction</h3>

<p>There is a <code>Commands</code> object that contains all the <code>regexp.Regexp</code> items that are used to find matches 
for commands. These are instantiated once during bot startup but I admit this part is a lot more 
repetitive than needed and I am still looking for ways to clean this up.</p>

<p>So if you have any suggestions, do let me know in the comments below!</p>
<pre class="highlight go"><code><span class="k">package</span><span class="x"> </span><span class="n">commands</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="s">"regexp"</span><span class="x">

</span><span class="k">type</span><span class="x"> </span><span class="n">Commands</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">rmt</span><span class="x">   </span><span class="o">*</span><span class="n">regexp</span><span class="o">.</span><span class="n">Regexp</span><span class="x">
    </span><span class="n">r</span><span class="x">     </span><span class="o">*</span><span class="n">regexp</span><span class="o">.</span><span class="n">Regexp</span><span class="x">
    </span><span class="n">l</span><span class="x">     </span><span class="o">*</span><span class="n">regexp</span><span class="o">.</span><span class="n">Regexp</span><span class="x">
    </span><span class="n">c</span><span class="x">     </span><span class="o">*</span><span class="n">regexp</span><span class="o">.</span><span class="n">Regexp</span><span class="x">
    </span><span class="n">cl</span><span class="x">    </span><span class="o">*</span><span class="n">regexp</span><span class="o">.</span><span class="n">Regexp</span><span class="x">
    </span><span class="n">hazel</span><span class="x"> </span><span class="o">*</span><span class="n">regexp</span><span class="o">.</span><span class="n">Regexp</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">NewCommandList</span><span class="p">()</span><span class="x"> </span><span class="n">Commands</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">Commands</span><span class="p">{</span><span class="x">
        </span><span class="n">rmt</span><span class="o">:</span><span class="x">   </span><span class="n">compileRegexp</span><span class="p">(</span><span class="s">`(?i)^(remind) me to (.+)`</span><span class="p">),</span><span class="x">
        </span><span class="n">r</span><span class="o">:</span><span class="x">     </span><span class="n">compileRegexp</span><span class="p">(</span><span class="s">`(?i)^(remind) (.+)`</span><span class="p">),</span><span class="x">
        </span><span class="n">l</span><span class="o">:</span><span class="x">     </span><span class="n">compileRegexp</span><span class="p">(</span><span class="s">`(?i)^(list)`</span><span class="p">),</span><span class="x">
        </span><span class="n">c</span><span class="o">:</span><span class="x">     </span><span class="n">compileRegexp</span><span class="p">(</span><span class="s">`(?i)^(clear) (\d+)`</span><span class="p">),</span><span class="x">
        </span><span class="n">cl</span><span class="o">:</span><span class="x">    </span><span class="n">compileRegexp</span><span class="p">(</span><span class="s">`(?i)^(clearall)`</span><span class="p">),</span><span class="x">
        </span><span class="n">hazel</span><span class="o">:</span><span class="x"> </span><span class="n">compileRegexp</span><span class="p">(</span><span class="s">`(?i)(hazel)`</span><span class="p">),</span><span class="x">
    </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">compileRegexp</span><span class="p">(</span><span class="n">s</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="o">*</span><span class="n">regexp</span><span class="o">.</span><span class="n">Regexp</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">r</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">regexp</span><span class="o">.</span><span class="n">Compile</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">r</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">c</span><span class="x"> </span><span class="o">*</span><span class="n">Commands</span><span class="p">)</span><span class="x"> </span><span class="n">Extract</span><span class="p">(</span><span class="n">t</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">var</span><span class="x"> </span><span class="n">a</span><span class="x"> </span><span class="p">[]</span><span class="kt">string</span><span class="x">

    </span><span class="n">a</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">c</span><span class="o">.</span><span class="n">rmt</span><span class="o">.</span><span class="n">FindStringSubmatch</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="m">3</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="k">return</span><span class="x"> </span><span class="n">a</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="x"> </span><span class="n">a</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="x">
    </span><span class="p">}</span><span class="x">

    </span><span class="o">...</span><span class="x">

    </span><span class="k">return</span><span class="x"> </span><span class="s">""</span><span class="p">,</span><span class="x"> </span><span class="s">""</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
<p><strong>A couple of comments for the code above:</strong></p>

<ul>
<li>The <code>(?i)</code> is there for case-insensitive regexp.</li>
<li>I parse the commands and return the command and messages separately back to the route handler for 
it to do more there.</li>
<li>If it doesn&rsquo;t match, it&rsquo;ll just return empty strings and subsequently gets thrown away.</li>
</ul>

<h3>Sending a Response</h3>

<p>I can send either a <code>GET</code> or a <code>POST</code> request to the appropriate API. I used the <code>sendMessage</code> method via the API.
The text in this case, can contain codes like <code>\n</code> and Unicode like <code>안녕</code>.</p>

<p>To replace the botId, apiKey, chatId and text for the <code>GET</code> request, I do the following:</p>
<pre class="highlight go"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">ac</span><span class="x"> </span><span class="o">*</span><span class="n">AppContext</span><span class="p">)</span><span class="x"> </span><span class="n">sendText</span><span class="p">(</span><span class="n">chatId</span><span class="x"> </span><span class="kt">int64</span><span class="p">,</span><span class="x"> </span><span class="n">text</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">link</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="s">"https://api.telegram.org/bot{botId}:{apiKey}/sendMessage?chat_id={chatId}&amp;text={text}"</span><span class="x">
    </span><span class="n">link</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">s</span><span class="o">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">link</span><span class="p">,</span><span class="x"> </span><span class="s">"{botId}"</span><span class="p">,</span><span class="x"> </span><span class="n">ac</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">BOT</span><span class="o">.</span><span class="n">BotId</span><span class="p">,</span><span class="x"> </span><span class="o">-</span><span class="m">1</span><span class="p">)</span><span class="x">
    </span><span class="n">link</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">s</span><span class="o">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">link</span><span class="p">,</span><span class="x"> </span><span class="s">"{apiKey}"</span><span class="p">,</span><span class="x"> </span><span class="n">ac</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">BOT</span><span class="o">.</span><span class="n">ApiKey</span><span class="p">,</span><span class="x"> </span><span class="o">-</span><span class="m">1</span><span class="p">)</span><span class="x">
    </span><span class="n">link</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">s</span><span class="o">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">link</span><span class="p">,</span><span class="x"> </span><span class="s">"{chatId}"</span><span class="p">,</span><span class="x"> </span><span class="n">strconv</span><span class="o">.</span><span class="n">FormatInt</span><span class="p">(</span><span class="n">chatId</span><span class="p">,</span><span class="x"> </span><span class="m">10</span><span class="p">),</span><span class="x"> </span><span class="o">-</span><span class="m">1</span><span class="p">)</span><span class="x">
    </span><span class="n">link</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">s</span><span class="o">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">link</span><span class="p">,</span><span class="x"> </span><span class="s">"{text}"</span><span class="p">,</span><span class="x"> </span><span class="n">url</span><span class="o">.</span><span class="n">QueryEscape</span><span class="p">(</span><span class="n">text</span><span class="p">),</span><span class="x"> </span><span class="o">-</span><span class="m">1</span><span class="p">)</span><span class="x">

    </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">link</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
<p>And it&rsquo;s done! The application code is pretty short I&rsquo;ll say.</p>

<h3>To Be Continued</h3>

<p>I hope this gives you a rough idea if you would like to get started in writing the application code for a Telegram Bot.</p>

<p>In Part 2, I will talk about how I set up <code>Docker</code> for the bot, and also
the self-signed SSL cert with Nginx as the reverse proxy on a Digital Ocean instance. Finally, 
I&rsquo;ll also show how I set up the git webhooks so that I can deploy with just one command!</p>

    </div>

    <div id='disqus_thread'></div>
<script type='text/javascript'>
//<![CDATA[
                  var disqus_shortname = 'homan-gh-blog';
                        var disqus_identifier = '2016/build-golang-telegram-bot-webhooks';
                        var disqus_title = 'How to Build a Golang Telegram Bot with Webhooks';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript>
<a href='http://disqus.com' class='dsq-brlink'>comments powered by <span class='logo-disqus'>Disqus</span></a>

    <script type="text/javascript">
//<![CDATA[
    var disqus_shortname = 'homan-gh-blog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script>

  </div>

      </div>
    </div>
  </body>
</html>
