<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Homan's</title>

    <!-- Bootstrap Stuff -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

    <link href="/stylesheets/normalize.css" rel="stylesheet" type="text/css" /><link href="/stylesheets/all.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/blog.css" rel="stylesheet" type="text/css" />

    <script src="/javascripts/all.js" type="text/javascript"></script>


  </head>
  <body class="posts posts_2015 posts_2015_05 posts_2015_05_05 posts_2015_05_05_golang-protobuf posts_2015_05_05_golang-protobuf_index">
    <div class="wrapper">
      <div class="mid-container">
        <h3>Golang</h3>

<p>I&rsquo;m sure most of you have heard about Golang by now, so I&rsquo;ll just fast forward past that. But in case you&rsquo;re not aware, do check out the relatively young language <a title="Golang" href="http://golang.org/">here</a>. </p>

<p>Recently, I&rsquo;ve had the chance to work with Golang in Wego to build our analytics API that will log our visits into flat files + upload them into Kafka for further processing, with one caveat: we&rsquo;re using Protobuf Buffers (or otherwise just Protobuf) for our serialisation of data.</p>

<h3>What is Protobuf?</h3>

<p>Its basically a protocol that comes with a language <a title="proto" href="https://developers.google.com/protocol-buffers/docs/proto">proto</a> with which you define your data structure once and then you can use this source code to generate helpers/classes/models for different languages such as Golang, Python, Ruby etc .. Do note that only C++, Python and Java are officially supported right now.</p>

<p>Think of it as XML, JSON but smaller, faster, and simpler; yet at the same time pretty defined and structured as well. 
So, Wego is set on replacing the semi-spaghetti JSON communication that we&rsquo;re currently working with, with Protobuf. </p>

<h3>Context</h3>

<p>As usual, the process always have some form of a bump for us to overcome before being able to use it. Typically, I think most golang protobuf repos will have rather simple/flat structure. </p>

<p>Our repo was built in a slightly odd that worked well to define the structure for other protobuf generators (we also use Protobuf for Ruby and Java). Below is a rough idea of how it looked like before a huge round of changes:</p>
<pre class="highlight plaintext"><code># OLD STRUCTURE
- protos
  - wego-protos
  - base.proto
  - flights.proto
  - hotels.proto
  - analytics.proto

  - wegosdk-protos (actually a symlink to ANOTHER repo)
  - flights
  - base.proto
  - hotels
  - base.proto
</code></pre>

<h3>The 1st Hurdle</h3>

<p>Well technically it isn&rsquo;t a bug, more like convention. The basic command for protoc (the tool that converts .proto files) which is shown below, is meant to be run once per package. This command will then look at the included files for a package name to compile them into. But initially, our files that were all in the root folder belong to separate packages. </p>
<pre class="highlight plaintext"><code>protoc --proto_path=./protos \
  --go_out ./libs/wego-protos-go \
  ./protos/wego-protos/flights.proto

protoc --proto_path=./protos \
  --go_out ./libs/wego-protos-go \
  ./protos/wego-protos/hotels.proto

...
...
</code></pre>

<p>Specifying one file at a time and repeating it for the 4 files did not work either. Because it would break the name spaces inside them; they essentially become the same package instead of separate packages. </p>

<p>This issue doesn&rsquo;t really exist in other languages because I think files are resolved file level in Java/Ruby but at a package level in Golang. <a title="import issue" href="https://github.com/golang/protobuf/issues/8">this issue</a> and <a title="commit" href="https://github.com/golang/protobuf/commit/dded9133a99a3cd7c3a9d24a9f85c2b8ef76ff31">this commit</a> describes it in fuller details.</p>

<p>And so to get past it, we restructured the files in this way, such that each of the packages reside in individual folders, following the convention of Golang. </p>
<pre class="highlight plaintext"><code># NEW STRUCTURE
- protos
  - wego-protos
   - wego
    - base.proto
   - flights
      - base.proto
   - hotels
    - base.proto 
   - analytics 
    - base.proto

  - wegosdk-protos (actually a symlink to ANOTHER repo)
  - flights
  - base.proto
  - hotels
  - base.proto
</code></pre>

<h3>The 2nd Problem</h3>

<p>This problem is abit uglier. So in the <code>wego-protos</code> files, we do imports that are from the other repo <code>wegosdk-protos</code>. It is an entirely separate git repo that is included as a git submodule. </p>
<pre class="highlight plaintext"><code>package wego.flights
import "wegosdk-protos/wegosdk/base.proto";
</code></pre>

<p>The generated package name from that snippet was wrong. I had to include an undocumented option go<em>package in proto2 (it is available in proto3). &ldquo;` option go</em>package = &quot;wego&rdquo;; &ldquo;`</p>

<p>This actually generates <code>import &quot;wegosdk-protos/wegosdk/base&quot;</code> in the *.pb.go files. It was clear that we needed to customise the import paths + package names.</p>

<p>Looking at <a title="protobuf code" href="https://github.com/golang/protobuf/blob/master/protoc-gen-go/plugin/Makefile#L38">this file</a>, we found that the &ndash;go-out has a &quot;M&rdquo; flag that allows us to modify the final import paths to point to the correct github.com/wego/wego-protos filepaths. We also don&rsquo;t do another <code>go get github.com/wego/wegosdk-proto</code>; basically treating it as one repo.</p>

<h3>The Solution</h3>

<p>Finally I ended up with this long &ndash;go-out option to somewhat &ldquo;replace&rdquo; all of the default imports (that works with other languages) to use the correct $GOPATH source path.</p>
<pre class="highlight plaintext"><code>--go-out=Mwegosdk-protos/wegosdk_hotels/base.proto=github.com/wego/wego-protos/libs/wego-protos-go/wegosdk-protos/wegosdk_hotels,
Mwegosdk-protos/wegosdk_flights/fares.proto=github.com/wego/wego-protos/libs/wego-protos-go/wegosdk-protos/wegosdk_flights,
Mwegosdk-protos/wegosdk_flights/base.proto=github.com/wego/wego-protos/libs/wego-protos-go/wegosdk-protos/wegosdk_flights,
Mwegosdk-protos/wegosdk/base.proto=github.com/wego/wego-protos/libs/wego-protos-go/wegosdk-protos/wegosdk,
Mwego-protos/wego_hotels/base.proto=github.com/wego/wego-protos/libs/wego-protos-go/wego-protos/wego_hotels,
Mwego-protos/wego_flights/base.proto=github.com/wego/wego-protos/libs/wego-protos-go/wego-protos/wego_flights,
Mwego-protos/wego_analytics/base.proto=github.com/wego/wego-protos/libs/wego-protos-go/wego-protos/wego_analytics,
Mwego-protos/wego/base.proto=github.com/wego/wego-protos/libs/wego-protos-go/wego-protos/wego,

</code></pre>

<p>On hindsight, it would probably have been alot easier if we just treated wegosdk-protos as an entirely separate project in Golang. Nevertheless I think the workaround is reasonable if we wanted to work with only 1 repo at that time.</p>

      </div>
    </div>
  </body>
</html>
